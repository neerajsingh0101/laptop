#!/usr/bin/env bash
#
# ab is built for finite runs: "send N requests with concurrency C" and then stop unlike
# simulate-traffic-simple which keeps sending requests continuously.
#
# ./simulate-traffic-ab <url> <requests_per_minute> [concurrency]
# - concurrency defaults to 1
#
# Send one request at a time like simulate-traffic
# ./simulate_traffic_ab https://example.com 100
#
# Send 600 requests/min with concurrency 10
# ./simulate_traffic_ab https://example.com 600 10
#
# About concurrency
# 600 requests per minute means 10 requests/second on average.
# Concurrency 10 means ~10 requests are in flight at once.
# One way to see it would be if the requetss take 2s and we fire every 0.1s
# then we have ~20 in flight.
#
# ab makes concurrency explicit with `-c` option.
# ab -n 1000 -c 1 URL -> one request is in flight at a time.
# ab -n 1000 -c 50 URL -> Upto 50 requests in flight at a time.
# Note that -n stands for total number of requests to perform in that run.
# ab by default doesn't keep sending requests that's why we need to run it in a loop.
# Irrespective of the concurrency level "-n" dictates total number of requests to be fired.

set -euo pipefail

if [[ $# -lt 2 ]]; then
  echo "Usage: $0 <url> <total_requests> [concurrency]" >&2
  exit 1
fi

# Check for ab
if ! command -v ab >/dev/null 2>&1; then
  cat >&2 <<'EOF'
Error: 'ab' (ApacheBench) is not installed.

Install it with Homebrew:
  brew install httpd

Then try again.
EOF
  exit 127
fi

URL="$1"
N="$2"
CONCURRENCY="${3:-1}"

# Basic validation
[[ "$N" =~ ^[0-9]+$ ]] && [[ "$N" -gt 0 ]] || { echo "Error: total_requests must be a positive integer" >&2; exit 1; }
[[ "$CONCURRENCY" =~ ^[0-9]+$ ]] && [[ "$CONCURRENCY" -gt 0 ]] || { echo "Error: concurrency must be a positive integer" >&2; exit 1; }
[[ "$N" -ge "$CONCURRENCY" ]] || { echo "Error: total_requests must be >= concurrency" >&2; exit 1; }

echo "Running: ab -n $N -c $CONCURRENCY $URL"
ab -n "$N" -c "$CONCURRENCY" "$URL"
