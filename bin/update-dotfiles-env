#!/usr/bin/env ruby
# frozen_string_literal: true
#
# This is invoked by install.sh.
# This creates ~/.dotfiles.env and sets DOTFILESD to the user's dotfiles directory.
#
require "fileutils"

home = Dir.home
link = File.join(home, ".dotfiles.env")

# Directory to set as DOTFILESD (defaults to current working directory)
target = Dir.pwd

p = target.start_with?(home) ? target.sub(/\A#{Regexp.escape(home)}/, "$HOME") : target
puts "home is #{home}"
puts "link is #{link}"
puts "target is #{target}"
puts "p is #{p}"

file  = target + "/zsh/dotfiles.env"

puts "file is #{file}"

content = %(export DOTFILESD="#{p}")

# Write atomically to avoid partial writes
tmp = "#{file}.tmp.#{$$}"
File.write(tmp, content)
FileUtils.mv(tmp, file)