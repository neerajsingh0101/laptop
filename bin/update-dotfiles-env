#!/usr/bin/env ruby
# frozen_string_literal: true
#
# This is invoked by install.sh.
# This creates ~/.dotfiles.env and sets DOTFILESD to the user's dotfiles directory.
#
require "fileutils"

def abort_with(msg, code: 1)
  warn msg
  exit code
end

home = Dir.home
link = ENV["DOTFILES_ENV_LINK"] || File.join(home, ".dotfiles.env")

# Directory to set as DOTFILESD (defaults to current working directory)
target = ARGV[0] || Dir.pwd

# Make it literal $HOME/... for portability in the env file
p = target.start_with?(home) ? target.sub(/\A#{Regexp.escape(home)}/, "$HOME") : target

# Resolve where we should actually write (follow symlink target if link is a symlink)
file = link
if File.symlink?(link)
  t = File.readlink(link)
  if t.start_with?("/")
    file = t
  else
    base_dir = File.dirname(link)
    file = File.expand_path(t, base_dir)
  end
end

# Ensure parent directory exists and file exists
FileUtils.mkdir_p(File.dirname(file))
FileUtils.touch(file)

replacement_line = %(export DOTFILESD="#{p}")
lines = File.exist?(file) ? File.read(file).lines : []

found = false
updated_lines = lines.map do |line|
  if line.match?(/\Aexport DOTFILESD=/)
    found = true
    replacement_line + "\n"
  else
    line
  end
end

unless found
  line1 = "# DOTFILESD is the directory where all the dotfiles repo is cloned\n"
  updated_lines << replacement_line + "\n"
end

# Write atomically to avoid partial writes
tmp = "#{file}.tmp.#{$$}"
File.write(tmp, updated_lines.join)
FileUtils.mv(tmp, file)