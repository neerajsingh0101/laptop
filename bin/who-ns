#!/bin/sh
#
# Shows NS records for a domain + guess the DNS provider
#
# who-ns neeto.com

set -eu

domain="${1:-}"
if [ -z "$domain" ]; then
  echo "Usage: $(basename "$0") <domain>" >&2
  exit 1
fi

# normalize: strip scheme/path, and trailing dot
domain=$(printf "%s" "$domain" \
  | sed -E 's#^[a-zA-Z]+://##; s#/.*$##; s/\.$//')

have_cmd() { command -v "$1" >/dev/null 2>&1; }

fetch_ns() {
  if have_cmd dig; then
    # +trace can be slow; default query is usually enough
    dig +short NS "$domain" 2>/dev/null | sed 's/\.$//' | awk 'NF' | sort -u
  elif have_cmd host; then
    # host output varies; pull the last field of "has name server" lines
    host -t ns "$domain" 2>/dev/null | awk '/name server/ {print $NF}' | sed 's/\.$//' | awk 'NF' | sort -u
  else
    echo "Error: need 'dig' (recommended) or 'host'." >&2
    echo "Install dig via: brew install bind" >&2
    exit 2
  fi
}

ns_list="$(fetch_ns || true)"

if [ -z "$ns_list" ]; then
  echo "No NS records found (or lookup failed) for: $domain" >&2
  exit 3
fi

echo "Domain: $domain"
echo "Name servers:"
printf "%s\n" "$ns_list" | sed 's/^/  - /'

guess_provider() {
  ns_all="$(printf "%s\n" "$ns_list" | tr '[:upper:]' '[:lower:]')"

  # Match common DNS provider patterns
  if echo "$ns_all" | grep -qE '(^|\.)cloudflare\.com$'; then
    echo "Cloudflare"
  elif echo "$ns_all" | grep -qE '(^|\.)domaincontrol\.com$'; then
    echo "GoDaddy"
  elif echo "$ns_all" | grep -qE '(^|\.)awsdns-[0-9]+(\.[a-z0-9-]+)*\.amazonaws\.com$|(^|\.)awsdns-[0-9]+\.(com|net|org|co\.uk)$'; then
    echo "Amazon Route 53"
  elif echo "$ns_all" | grep -qE '(^|\.)dnsimple\.com$'; then
    echo "DNSimple"
  elif echo "$ns_all" | grep -qE '(^|\.)nsone\.net$'; then
    echo "NS1"
  elif echo "$ns_all" | grep -qE '(^|\.)dnsmadeeasy\.com$'; then
    echo "DNS Made Easy"
  elif echo "$ns_all" | grep -qE '(^|\.)googledomains\.com$|(^|\.)google\.com$'; then
    echo "Google Domains / Google-managed DNS"
  elif echo "$ns_all" | grep -qE '(^|\.)azure-dns\.(com|net|org|info)$'; then
    echo "Azure DNS"
  elif echo "$ns_all" | grep -qE '(^|\.)digitalocean\.com$'; then
    echo "DigitalOcean DNS"
  elif echo "$ns_all" | grep -qE '(^|\.)registrar-servers\.com$'; then
    echo "Namecheap"
  elif echo "$ns_all" | grep -qE '(^|\.)fastdns\.net$|(^|\.)ultradns\.'; then
    echo "UltraDNS / Neustar"
  else
    echo "Unknown (provider not recognized from NS hostnames)"
  fi
}

echo "Provider guess: $(guess_provider)"
