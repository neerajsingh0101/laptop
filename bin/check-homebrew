#!/usr/bin/env bash
#
# Verify that Homebrew is properly installed and configured.
#
# Usage: check-homebrew
#
set -euo pipefail

echo "==> Checking Homebrew setup..."
echo ""

errors=0

fail() {
  echo "FAIL: $*"
  errors=$((errors + 1))
}

warn() {
  echo "WARN: $*"
}

pass() {
  echo "PASS: $*"
}

# ── 1. Homebrew is installed ────────────────────────────────────────────
if ! command -v brew >/dev/null 2>&1; then
  echo "FAIL: Homebrew is not installed."
  echo "      Install it from https://brew.sh"
  echo ""
  echo "1 check(s) failed. Please review the output above."
  exit 1
fi

brew_prefix="$(brew --prefix)"
pass "Homebrew is installed at $brew_prefix"

# ── 2. Correct prefix for the architecture ──────────────────────────────
arch="$(uname -m)"
if [ "$arch" = "arm64" ]; then
  expected_prefix="/opt/homebrew"
else
  expected_prefix="/usr/local"
fi

if [ "$brew_prefix" = "$expected_prefix" ]; then
  pass "Homebrew prefix ($brew_prefix) is correct for $arch."
else
  fail "Homebrew prefix is $brew_prefix but expected $expected_prefix for $arch."
fi

# ── 3. Homebrew bin appears in PATH before /usr/local/bin ───────────────
# On Apple Silicon, /opt/homebrew/bin should come before /usr/local/bin
# so Homebrew-installed tools take priority over legacy Intel ones.
brew_bin="$brew_prefix/bin"
homebrew_pos=""
usr_local_pos=""
pos=0

IFS=':' read -r -a path_entries <<< "$PATH"
for entry in "${path_entries[@]}"; do
  if [ -z "$homebrew_pos" ] && [ "$entry" = "$brew_bin" ]; then
    homebrew_pos=$pos
  fi
  if [ -z "$usr_local_pos" ] && [ "$entry" = "/usr/local/bin" ]; then
    usr_local_pos=$pos
  fi
  pos=$((pos + 1))
done

if [ -z "$homebrew_pos" ]; then
  fail "$brew_bin is not in PATH."
elif [ -n "$usr_local_pos" ] && [ "$homebrew_pos" -gt "$usr_local_pos" ]; then
  fail "$brew_bin (position $homebrew_pos) appears after /usr/local/bin (position $usr_local_pos) in PATH.
      Homebrew tools may be shadowed by legacy Intel versions."
else
  pass "$brew_bin appears in PATH before /usr/local/bin."
fi

# ── 4. HOMEBREW_PREFIX is set (nice-to-have in scripts) ─────────────────
# Note: HOMEBREW_PREFIX is usually set by `eval "$(brew shellenv)"` in interactive shells.
# In scripts, relying on `brew --prefix` is more reliable.
if [ -n "${HOMEBREW_PREFIX:-}" ]; then
  if [ "$HOMEBREW_PREFIX" = "$brew_prefix" ]; then
    pass "HOMEBREW_PREFIX is set to $HOMEBREW_PREFIX"
  else
    warn "HOMEBREW_PREFIX is set to $HOMEBREW_PREFIX but brew --prefix is $brew_prefix.
      Your shell may be initializing multiple Homebrew installs."
  fi
else
  warn "HOMEBREW_PREFIX is not set (this is normal for non-interactive scripts).
      For shells, ensure 'eval \"\$(brew shellenv)\"' is in your config."
fi

# ── 5. OpenSSL is installed via Homebrew ────────────────────────────────
openssl_formula=""
if brew list --formula openssl@3 >/dev/null 2>&1; then
  openssl_formula="openssl@3"
elif brew list --formula openssl >/dev/null 2>&1; then
  openssl_formula="openssl"
fi

if [ -n "$openssl_formula" ]; then
  openssl_prefix="$(brew --prefix "$openssl_formula")"
  pass "$openssl_formula is installed via Homebrew at $openssl_prefix"

  # Check that the 'openssl' on PATH is Homebrew's (nice-to-have)
  openssl_path="$(command -v openssl 2>/dev/null || true)"
  if [ -n "$openssl_path" ]; then
    # macOS doesn't have readlink -f by default; realpath may or may not exist.
    real_openssl="$(realpath "$openssl_path" 2>/dev/null || echo "$openssl_path")"
    if echo "$real_openssl" | grep -q "$brew_prefix"; then
      pass "'openssl' in PATH points to Homebrew version ($openssl_path)."
    else
      warn "'openssl' in PATH is $openssl_path (not the Homebrew version).
      This is usually fine; builds often use the Homebrew one via explicit paths/pkg-config."
    fi
  fi
else
  fail "OpenSSL is not installed via Homebrew.
      Run: brew install openssl@3"
fi

# ── 6. Key formulae from bin/setup are present ────────────────────────
echo ""
echo "==> Checking key formulae..."
echo ""

formulae=(
  git-delta
  mise
  zsh-autosuggestions
  zsh-syntax-highlighting
  redis
)

for formula in "${formulae[@]}"; do
  if brew list --formula "$formula" >/dev/null 2>&1; then
    pass "$formula is installed."
  else
    fail "$formula is not installed. Run: brew install $formula"
  fi
done

# ── 7. brew doctor ──────────────────────────────────────────────────────
echo ""
echo "==> Running brew doctor..."
echo ""

# brew doctor can be noisy; treat non-zero as WARN, not FAIL.
if brew doctor 2>&1; then
  pass "brew doctor completed."
else
  warn "brew doctor reported warnings (see above)."
fi

# ── Summary ─────────────────────────────────────────────────────────────
echo ""
if [ "$errors" -eq 0 ]; then
  echo "All Homebrew checks passed."
else
  echo "$errors check(s) failed. Please review the output above."
  exit 1
fi
