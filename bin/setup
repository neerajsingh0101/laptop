#!/usr/bin/env bash
#
# set -e tells bash: exit immediately if any command returns a
# non-zero status (i.e., “fails”).
# It does not always trigger in every context.
# * If the `if` condition fails then it won't exit.
# * might_fail || echo "handled"    # won’t exit because `||` handles it
set -eE
trap 'echo "Error on line $LINENO (exit code $?)" >&2' ERR

# Update DEVBOXD based on where setup is being run from
./bin/create-devbox-env

# Load .devbox.env (source local file since $HOME symlink may not exist yet)
[ -f "./zsh/.devbox" ] && source "./zsh/.devbox"
LAPTOPD="$DEVBOXD/laptop"

# Remove destination (file/symlink/dir) and recreate symlink
# If destination is a real file (not a symlink), back it up first
link_force() {
  src="$1"
  dst="$2"

  if [ -z "$src" ] || [ -z "$dst" ]; then
    echo "Usage: link_force <src> <dst>" >&2
    return 1
  fi

  if [ ! -e "$src" ] && [ ! -L "$src" ]; then
    echo "Missing source: $src" >&2
    return 1
  fi

  # Backup dst if it's a real file (not a symlink)
  if [ -e "$dst" ] && [ ! -L "$dst" ]; then
    backup="${dst}-bkp-$(date +%Y%m%d%H%M%S)"
    echo "Backing up $dst to $backup"
    mv -- "$dst" "$backup"
  else
    rm -rf -- "$dst"
  fi

  ln -s -- "$src" "$dst"
}

link_force "$LAPTOPD/zsh/zshrc"          "$HOME/.zshrc"
link_force "$LAPTOPD/zsh/.devbox"         "$HOME/.devbox"

link_force "$LAPTOPD/symlinks/.gemrc"    "$HOME/.gemrc"
link_force "$LAPTOPD/symlinks/.gitconfig" "$HOME/.gitconfig"
link_force "$LAPTOPD/symlinks/.gitignore" "$HOME/.gitignore"
link_force "$LAPTOPD/symlinks/.irbrc"    "$HOME/.irbrc"
link_force "$LAPTOPD/symlinks/.psqlrc"   "$HOME/.psqlrc"
link_force "$LAPTOPD/symlinks/.wezterm.lua"   "$HOME/.wezterm.lua"

if [ -f "$LAPTOPD/symlinks/wezterm_local.lua" ]; then
  mkdir -p "$HOME/.config/wezterm"
  link_force "$LAPTOPD/symlinks/wezterm_local.lua"   "$HOME/.config/wezterm/wezterm_local.lua"
fi


# Install Homebrew if not already installed
if ! command -v brew &> /dev/null; then
  echo "Homebrew not found. Installing..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Make sure we're using the latest Homebrew.
brew update

# Upgrade any already-installed formulae.
brew upgrade

brew install zoxide    # for jumping around
brew install fzf
brew install atuin     # better history
brew install eza       # this is replacement for ls
brew install git
brew install git-delta # Used in pager
brew install httpd     # ab(apache bench) comes with this
brew install k6        # see bin/simulate-traffic-k6
brew install gh        # GitHub CLI
brew install jq
brew install yarn
brew install zsh-autosuggestions
brew install zsh-syntax-highlighting
brew install mise
brew install aicommits
brew install postgresql@18
brew install redis
brew install font-hack-nerd-font


# try install; if it fails due to an existing app, adopt; if adopt fails, force.
cask_install() {
  local cask="$1"
  if brew list --cask "$cask" >/dev/null 2>&1; then
    echo "Already installed: $cask"
    return 0
  fi

  brew install --cask "$cask" && return 0

  echo "Install failed for $cask; trying --adopt..."
  brew install --cask "$cask" --adopt && return 0

  echo "Adopt failed for $cask; trying --force..."
  brew install --cask "$cask" --force
}

cask_install raycast
cask_install whatsapp
cask_install visual-studio-code
cask_install wezterm
cask_install meetingbar

# Install Claude Code
/bin/bash -c "$(curl -fsSL https://claude.ai/install.sh)"

# write ~/.gitconfig.local
ruby ./bin/setup-gitconfig-local.rb

echo ""
echo "Would you like to reset Raycast settings and apply"
echo "the ones provided by Neeto?"
echo "If you have not customized your Raycast yet then you should hit \"c\"."
read -p "Hit Enter to keep current settings. Press c to change." answer
if [[ "$answer" =~ ^[Cc](hange)?$ ]]; then
  ./bin/fetch-latest-raycast-export

  echo ""
  echo "To import Raycast settings:"
  echo "  1. Open Raycast"
  echo "  2. Press Cmd and comma(,) to open Settings"
  echo "  3. Click on the 'Advanced' tab"
  echo "  4. Scroll to 'Import & Export'"
  echo "  5. Click 'Import'"
  echo "  6. Choose 'latest-raycast-export.rayconfig' from your Downloads folder"
  echo ""
  echo "Waiting for you to finish the steps above."
  while true; do
    read -p "Press D when are done: " key
    [[ "$key" =~ ^[Dd]$ ]] && break
  done
fi

echo ""
echo "Applying customize Macos"
echo "You will be asked to provide your laptop password"
./bin/customize-macos

echo ""
echo "Would you like to set up a GitHub SSH key?"
echo "If you already have one configured, then you can skip."
read -p "Hit Enter to skip. Press c to set up your SSH key. " answer
if [[ "$answer" =~ ^[Cc](hange)?$ ]]; then
  ./bin/setup-github-ssh-key
fi

echo ""
echo "You are all done. Please go through xxx to read the documentation."
echo "There is also a Youtube video at xxxx"