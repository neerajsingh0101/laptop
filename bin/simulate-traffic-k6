#!/usr/bin/env bash
#
# There are open-ended and close-ended load testing tools.
# In closed model a new request is triggered only when the previous
# request is closed(completed). In open model new requests are triggered
# independently of the completion of previous requests. All requests where
# one needs to maintain certain requests per second are part of open model.
#
# ./simulate-traffic-k6 <url> <requests_per_minute>
#
# DURATION=2h VUS=50 MAX_VUS=300 ./simulate-traffic-k6 https://neeto.com 100
#
# In the script the default value for duration is set to 24 hours. It means
# the script will run for 24 hours. It can be killed with Ctrl+C. As you can
# see above DURATION can be passed inline to change that value.
#
# VUS stands for "Virtual users". In K6 terms each virtual user is making
# one request. Let's say that we are trying to have 100 requests per minute.
# K6 will start with some pre-allocated number of VUS. Since it needs to
# maintain constant-arrival-rate if the server is slow in responding then
# K6 will create more virtual user since the existing virtual users might
# still be waiting for the response to come.
#
# VUs are single threaded, like other JavaScript runtimes, a VU can only run
# a single iteration (and its event loop) at a time. More on this topic at
# https://grafana.com/docs/k6/latest/using-k6/scenarios/concepts/arrival-rate-vu-allocation/
#
# If the server is quick in responding then K6 doesn't need to create more virtual
# users. MAX_VUS sets the maximum number of virtual users that will be created.
#
# K6 has checks(https://grafana.com/docs/k6/latest/using-k6/checks/) and
# Thresholds(https://grafana.com/docs/k6/latest/using-k6/thresholds/)
# to define what constitutes a success. This is a great feature which is not
# available in other load testing tools.
#
# K6 is also much more configurable when it comes to handling result output.
# More on this at https://grafana.com/docs/k6/latest/results-output.
#
# If the setup requires logging in, clicking on button1 and then clicking on a
# a link then k6 can handle it better than other load testing tool.
#
# More information about constant arrival rate is at
# https://grafana.com/docs/k6/latest/using-k6/scenarios/executors/constant-arrival-rate
#
# K6 also supports Ramping arrival rate. In this case you can send certain number
# of requests then increase the load then you can decrease the load to see
# how system performs under various load. More on this at
# https://grafana.com/docs/k6/latest/using-k6/scenarios/executors/ramping-arrival-rate/
#
set -euo pipefail

url="${1:-}"
rpm="${2:-}"

# Optional env knobs
duration="${DURATION:-24h}"      # Ctrl+C to stop
vus="${VUS:-20}"
max_vus="${MAX_VUS:-200}"

usage() {
  cat >&2 <<EOF
Usage:
  $(basename "$0") <url> <rpm>

Example:
  $(basename "$0") https://neeto.com 100

Optional env vars:
  DURATION=24h   (default: $duration)
  VUS=20         (default: $vus)
  MAX_VUS=200    (default: $max_vus)
EOF
}

[[ -n "$url" && -n "$rpm" ]] || { usage; exit 1; }
command -v k6 >/dev/null 2>&1 || {
  echo "k6 is not installed. Install it with: brew install k6" >&2
  exit 1
}

# Basic numeric check
if ! [[ "$rpm" =~ ^[0-9]+$ ]] || [[ "$rpm" -le 0 ]]; then
  echo "RPM must be a positive integer. Got: $rpm" >&2
  exit 1
fi

tmpdir="$(mktemp -d)"
script="$tmpdir/k6_traffic.js"
cleanup() { rm -rf "$tmpdir"; }
trap cleanup EXIT

cat > "$script" <<'JS'
import http from "k6/http";
import { check } from "k6";

const URL = __ENV.URL;
const RPM = Number(__ENV.RPM || "100");

export const options = {
  scenarios: {
    rpm: {
      executor: "constant-arrival-rate",
      rate: RPM,
      timeUnit: "1m",           // RPM
      duration: __ENV.DURATION || "24h",
      preAllocatedVUs: Number(__ENV.VUS || "20"),
      maxVUs: Number(__ENV.MAX_VUS || "200"),
    },
  },
  thresholds: {
    http_req_failed: ["rate<0.01"],
  },
};

export default function () {
  const res = http.get(URL, { redirects: 5 });

  check(res, {
    "status is 200-399": (r) => r.status >= 200 && r.status < 400,
  });
}
JS

echo "Hitting:  $url"
echo "Rate:     $rpm RPM"
echo "Duration: $duration (Ctrl+C to stop)"
echo "VUs:      $vus (max $max_vus)"
echo

exec k6 run \
  -e URL="$url" \
  -e RPM="$rpm" \
  -e DURATION="$duration" \
  -e VUS="$vus" \
  -e MAX_VUS="$max_vus" \
  "$script"
