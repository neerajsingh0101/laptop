#!/usr/bin/env bash
#
# set -e tells bash: exit immediately if any command returns a
# non-zero status (i.e., “fails”).
# It does not always trigger in every context.
# * If the `if` condition fails then it won't exit.
# * might_fail || echo "handled"    # won’t exit because `||` handles it
set -e

# Update DOTFILESD based on where install.sh is being run from
./bin/create-dotfiles-env

# Load dotfiles.env (source local file since $HOME symlink may not exist yet)
[ -f "./zsh/dotfiles.env" ] && source "./zsh/dotfiles.env"

# Remove destination (file/symlink/dir) and recreate symlink
# If dst is a real file (not a symlink), back it up first
link_force() {
  src="$1"
  dst="$2"

  if [ -z "$src" ] || [ -z "$dst" ]; then
    echo "Usage: link_force <src> <dst>" >&2
    return 1
  fi

  if [ ! -e "$src" ] && [ ! -L "$src" ]; then
    echo "Missing source: $src" >&2
    return 1
  fi

  # Backup dst if it's a real file (not a symlink)
  if [ -e "$dst" ] && [ ! -L "$dst" ]; then
    backup="${dst}-bkp-$(date +%Y%m%d%H%M%S)"
    echo "Backing up $dst to $backup"
    mv -- "$dst" "$backup"
  else
    rm -rf -- "$dst"
  fi

  ln -s -- "$src" "$dst"
}

link_force "$DOTFILESD/zsh/zshrc"          "$HOME/.zshrc"
link_force "$DOTFILESD/zsh/dotfiles.env"   "$HOME/.dotfiles.env"

link_force "$DOTFILESD/symlinks/.gemrc"    "$HOME/.gemrc"
link_force "$DOTFILESD/symlinks/.gitconfig" "$HOME/.gitconfig"
link_force "$DOTFILESD/symlinks/.gitignore" "$HOME/.gitignore"
link_force "$DOTFILESD/symlinks/.irbrc"    "$HOME/.irbrc"
link_force "$DOTFILESD/symlinks/.psqlrc"   "$HOME/.psqlrc"
link_force "$DOTFILESD/symlinks/.wezterm.lua"   "$HOME/.wezterm.lua"

if [ -f "$DOTFILESD/symlinks/wezterm_local.lua" ]; then
  mkdir -p "$HOME/.config/wezterm"
  link_force "$DOTFILESD/symlinks/wezterm_local.lua"   "$HOME/.config/wezterm/wezterm_local.lua"
fi

ruby ./bin/update-gitconfig-local.rb

# Check if Homebrew is installed
if ! command -v brew &> /dev/null; then
  echo "Error: Homebrew is not installed." >&2
  echo "Please install Homebrew. Visit https://brew.sh to see instructions." >&2
  exit 1
fi

# Make sure we're using the latest Homebrew.
brew update

# Upgrade any already-installed formulae.
brew upgrade

# Save Homebrew's installed location.
BREW_PREFIX=$(brew --prefix)

brew install zoxide    # for jumping around
brew install fzf
brew install atuin     # better history
brew install eza       # this is replacement for ls
brew install git-delta # Usee for pager
brew install httpd     # ab(apache bench) comes with this
brew install k6        # see bin/simulate-traffice-k6
brew install gh        # GitHub CLI
brew install jq
brew install zsh-autosuggestions
brew install zsh-syntax-highlighting
brew install rbenv
brew install aicommits
brew install postgresql@18
brew install redis

# try install; if it fails due to an existing app, adopt; if adopt fails, force.
cask_install() {
  local cask="$1"
  if brew list --cask "$cask" >/dev/null 2>&1; then
    echo "Already installed: $cask"
    return 0
  fi

  brew install --cask "$cask" && return 0

  echo "Install failed for $cask; trying --adopt..."
  brew install --cask "$cask" --adopt && return 0

  echo "Adopt failed for $cask; trying --force..."
  brew install --cask "$cask" --force
}

cask_install raycast
cask_install whatsapp
cask_install visual-studio-code
cask_install iterm2
cask_install wezterm
cask_install meetingbar

brew install font-hack-nerd-font

# Install nvm (Node Version Manager)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash

# Install Claude Code
curl -fsSL https://claude.ai/install.sh | bash

echo ""
echo "Next: apply macOS defaults by running:"
echo "  ./bin/customize-macos"
echo ""
