#!/bin/sh
#
# Open the restricted pages of nytimes
#
# nytimes url

set -eu

url="${1:-}"
scratch="${NYTIMES_SCRATCH_DIR:-$HOME/scratch}"

if [ -z "$url" ]; then
  echo "Usage: nytimes <nytimes-url>" >&2
  exit 1
fi

# Strip fragment and query string
clean=${url%%#*}
clean=${clean%%\?*}

# Remove scheme
case "$clean" in
  http://*)  clean=${clean#http://} ;;
  https://*) clean=${clean#https://} ;;
esac

# Split host + path
host=${clean%%/*}
if [ "$clean" = "$host" ]; then
  path="/"
else
  path="/${clean#*/}"
fi

# Build output path mirroring the URL
if [ "$path" = "/" ]; then
  dir="$scratch/$host"
  file="index.html"
else
  file=${path##*/}      # basename
  dirpart=${path%/*}    # dirname (may be empty for "/foo")
  dir="$scratch/$host$dirpart"

  if [ -z "$file" ] || [ "$file" = "/" ]; then
    file="index.html"
  fi

  case "$file" in
    *.*) : ;;
    *) file="$file.html" ;;
  esac
fi

/bin/mkdir -p "$dir"
out="$dir/$file"

printf 'url = "%s"\n' "$clean" | /usr/bin/curl -K- -A "googlebot" -L -sS > "$out"

# macOS open (fallback to xdg-open if present)
if command -v open >/dev/null 2>&1; then
  open "$out"
elif command -v xdg-open >/dev/null 2>&1; then
  xdg-open "$out"
else
  echo "Saved to: $out"
fi
