#!/usr/bin/env ruby
# frozen_string_literal: true

# setup_github_ssh_key
#
# Usage:
#   setup_github_ssh_key you@example.com
#   setup_github_ssh_key
#
# What it does:
# - Generates an Ed25519 SSH key at ~/.ssh/id_ed25519 (refuses to overwrite)
# - Starts ssh-agent (for this process/session) and adds the key
# - Copies the public key to clipboard on macOS (pbcopy) if available
# - Prints next steps + test command

require "fileutils"
require "open3"

def command_exists?(cmd)
  system("command -v #{cmd} >/dev/null 2>&1")
end

def run!(cmd)
  puts "â€º #{cmd}"
  success = system(cmd)
  raise "Command failed: #{cmd}" unless success
end

def capture!(cmd)
  stdout, status = Open3.capture2(cmd)
  raise "Command failed: #{cmd}" unless status.success?
  stdout
end

email = ARGV[0].to_s.strip
if email.empty?
  print "Enter the email to tag this SSH key with: "
  email = STDIN.gets.to_s.strip
end

if email.empty?
  warn "Error: email is required."
  exit 1
end

home = ENV.fetch("HOME")
ssh_dir = File.join(home, ".ssh")
key_path = File.join(ssh_dir, "id_ed25519")
pub_path = "#{key_path}.pub"

FileUtils.mkdir_p(ssh_dir)
FileUtils.chmod(0o700, ssh_dir)

if File.exist?(key_path) || File.exist?(pub_path)
  warn "Error: #{key_path} already exists."
  warn "Refusing to overwrite. Move it aside or delete it, then re-run."
  warn "  mv #{key_path} #{key_path}.bak"
  warn "  mv #{pub_path} #{pub_path}.bak"
  exit 1
end

puts "== Generating SSH key =="
run!(%(ssh-keygen -t ed25519 -C "#{email}" -f "#{key_path}"))

puts
puts "== Starting ssh-agent =="
agent_output = capture!("ssh-agent -s")
puts agent_output

# Export SSH_AUTH_SOCK / SSH_AGENT_PID into this Ruby process environment
agent_output.lines.each do |line|
  if line =~ /\A(SSH_AUTH_SOCK|SSH_AGENT_PID)=([^;]+);/
    ENV[$1] = Regexp.last_match(2)
  end
end

if ENV["SSH_AUTH_SOCK"].to_s.empty?
  warn "Warning: couldn't parse SSH_AUTH_SOCK from ssh-agent output."
  warn "ssh-add might fail; if it does, open a new shell and run:"
  warn "  eval \"$(ssh-agent -s)\""
  warn "  ssh-add --apple-use-keychain ~/.ssh/id_ed25519"
end

puts "== Adding key to ssh-agent =="
added = system(%(ssh-add --apple-use-keychain "#{key_path}" 2>/dev/null))
added ||= system(%(ssh-add "#{key_path}"))
raise "Failed to add SSH key to ssh-agent." unless added

puts
puts "== Public key =="
pub_key = File.read(pub_path)
puts pub_key

if command_exists?("pbcopy")
  IO.popen("pbcopy", "w") { |io| io.write(pub_key) }
  puts "Public key copied to clipboard."
else
  puts "pbcopy not found; copy the key above manually."
end

puts
puts "== Add it to GitHub =="
puts "GitHub -> Settings -> SSH and GPG keys -> New SSH key"
puts 'Paste the key, name it (e.g. "MacBook"), and save.'

puts
puts "== Test =="
puts "ssh -T git@github.com"
puts "(First time it may ask to trust GitHub's host key -- type 'yes'.)"

puts
puts "Done."
