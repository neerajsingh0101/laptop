#!/bin/bash
#
# Displays all the remote branches which have not been updated in the
# last one year and will interactively ask the user if the user wishes
# to delete the remote branch or not.

# Get date from 1 year ago (try Linux, then macOS format)
one_year_ago=$(date -d '1 year ago' +%Y-%m-%d 2>/dev/null || date -v-1y +%Y-%m-%d 2>/dev/null)

echo "Finding remote branches last updated before $one_year_ago..."
echo ""

# Fetch latest remote info
echo "Fetching latest remote information..."
git fetch --prune
echo ""

# Create temporary file with old branches
temp_file=$(mktemp)
git for-each-ref --sort=committerdate --format='%(committerdate:short)|%(refname:short)|%(authorname)' refs/remotes/origin > "$temp_file"

count=0
deleted=0
skipped=0

while IFS='|' read -r date branch author; do
  branch_name="${branch#origin/}"

  # Compare dates
  if [[ "$date" < "$one_year_ago" ]]; then
    # Skip HEAD and protected branches
    if [[ "$branch_name" == "HEAD" || "$branch_name" == "main" || "$branch_name" == "master" || "$branch_name" == "develop" || "$branch_name" == "production" || "$branch_name" == "staging" || "$branch_name" == "releases" || "$branch_name" =~ ^release/ ]]; then
      continue
    fi

    count=$((count + 1))

    # Calculate how old the branch is
    branch_timestamp=$(date -d "$date" +%s 2>/dev/null || date -j -f "%Y-%m-%d" "$date" +%s 2>/dev/null)
    current_timestamp=$(date +%s)
    days_old=$(( (current_timestamp - branch_timestamp) / 86400 ))
    years_old=$(( days_old / 365 ))
    months_old=$(( (days_old % 365) / 30 ))

    if [ $years_old -gt 0 ]; then
      if [ $months_old -gt 0 ]; then
        age_text="$years_old year(s) and $months_old month(s) old"
      else
        age_text="$years_old year(s) old"
      fi
    else
      age_text="$months_old month(s) old"
    fi

    # Clear screen for better visibility (optional - comment out if you don't want this)
    # clear

    echo "========================================"
    echo "Branch #$count"
    echo "========================================"
    echo "Name: $branch_name"
    echo "Last updated: $date ($age_text)"
    echo "Author: $author"
    echo ""
    echo "Options:"
    echo "  y - DELETE this branch"
    echo "  n - SKIP this branch"
    echo "  q - QUIT the script"
    echo ""
    echo -n "Your choice [y/n/q]: "

    # Read from terminal explicitly
    read -r response < /dev/tty

    case "$response" in
      [Yy]|[Yy][Ee][Ss])
        echo ""
        echo "üóëÔ∏è  Deleting $branch_name from remote..."
        if git push origin --delete "$branch_name" 2>&1; then
          echo "‚úì Successfully deleted $branch_name"
          deleted=$((deleted + 1))
        else
          echo "‚úó Failed to delete $branch_name"
        fi
        ;;
      [Qq]|[Qq][Uu][Ii][Tt])
        echo ""
        echo "Quitting..."
        echo ""
        echo "Summary:"
        echo "  Deleted: $deleted branches"
        echo "  Skipped: $skipped branches"
        rm -f "$temp_file"
        exit 0
        ;;
      *)
        echo "‚è≠Ô∏è  Skipped $branch_name"
        skipped=$((skipped + 1))
        ;;
    esac
    echo ""
    sleep 0.5  # Small delay to let you see the result
  fi
done < "$temp_file"

rm -f "$temp_file"

echo "========================================"
echo "All done!"
echo "========================================"
echo "Summary:"
echo "  Total old branches found: $count"
echo "  Deleted: $deleted branches"
echo "  Skipped: $skipped branches"
echo ""
