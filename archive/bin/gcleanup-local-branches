#!/bin/bash

# Script to delete local branches whose remote counterparts have been merged
# Run this from your git repository.

echo "Fetching latest changes from remote..."
git fetch --prune

echo -e "\nFinding local branches with merged remotes...\n"

# Get current branch to avoid deleting it
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Find branches to delete
branches_to_delete=()

for branch in $(git for-each-ref --format='%(refname:short)' refs/heads/); do
  # Skip protected branches
  if [ "$branch" = "$current_branch" ] || \
     [ "$branch" = "main" ] || \
     [ "$branch" = "master" ] || \
     [ "$branch" = "production" ] || \
     [ "$branch" = "staging" ] || \
     [ "$branch" = "release" ]; then
    continue
  fi

  echo "branch is $branch"

  # Check if remote tracking branch exists
#   remote_branch=$(git config --get "branch.$branch.merge" 2>/dev/null)
  remote_branch=$(git ls-remote --heads origin $branch 2>/dev/null)

  echo "remote_branch is $remote_branch"

  if [ -n "$remote_branch" ]; then
    # Extract branch name from refs/heads/branch-name
    remote_branch_name=${remote_branch#refs/heads/}
    remote_name=$(git config --get "branch.$branch.remote" 2>/dev/null)

    if [ -n "$remote_name" ]; then
      full_remote="$remote_name/$remote_branch_name"

      # Check if remote branch still exists
      if git show-ref --verify --quiet "refs/remotes/$full_remote"; then
        # Check if remote branch is merged into remote main/master
        if git branch -r --merged origin/main | grep -q "$full_remote" || \
           git branch -r --merged origin/master | grep -q "$full_remote" 2>/dev/null; then
          branches_to_delete+=("$branch")
        fi
      else
        # Remote branch doesn't exist anymore (was deleted)
        echo "  $branch (remote deleted)"
        branches_to_delete+=("$branch")
      fi
    fi
  fi
done

# Display and confirm deletion
if [ ${#branches_to_delete[@]} -eq 0 ]; then
  echo "No branches to delete."
  exit 0
fi

echo "The following branches will be deleted:"
for branch in "${branches_to_delete[@]}"; do
  echo "  - $branch"
done

echo -e "\nDo you want to delete these branches? (y/N)"
read -r response

if [[ "$response" =~ ^[Yy]$ ]]; then
  echo -e "\nDeleting branches..."
  for branch in "${branches_to_delete[@]}"; do
    git branch -d "$branch" 2>/dev/null && echo "  ✓ Deleted $branch" || \
    git branch -D "$branch" && echo "  ✓ Force deleted $branch"
  done
  echo -e "\nDone!"
else
  echo "Cancelled. No branches were deleted."
fi
